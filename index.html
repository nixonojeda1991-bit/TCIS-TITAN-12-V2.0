<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        // --- 1. CONFIGURACI√ìN (Blindaje B√°sico) ---
        const TITAN_CLOUD_URL = "https://us-central1-tcis-titan-12.cloudfunctions.net/agos-v11"; // Tu enlace real
        const TITAN_PUBLIC_KEY = "TITAN_CLAVE_123"; // La llave que configuramos en la terminal

        // Configuraci√≥n Firebase (Pega tu API KEY aqu√≠ abajo donde est√°n las comillas vac√≠as)
        const firebaseConfig = {
            apiKey: "AIzaSyCCcS9E9nGEb2cg0vVjBGLX01G-McfjN-M", 
            authDomain: "tcis-titan-12.firebaseapp.com",
            projectId: "tcis-titan-12",
            storageBucket: "tcis-titan-12.firebasestorage.app",
            messagingSenderId: "298942508038",
            appId: "1:298942508038:web:a7107a1cdc65216ec96787"
        };

        // Inicializaci√≥n segura
        let app, auth, db, userId;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) { userId = user.uid; } 
                else { 
                    try { const anon = await signInAnonymously(auth); userId = anon.user.uid; }
                    catch(e) { console.log("Modo Invitado (Sin Firebase)"); }
                }
            });
        } catch (e) { console.log("Firebase no configurado a√∫n, operando en modo local."); }

        // Sliders Visuales
        const ga = document.getElementById('ga');
        const gi = document.getElementById('gi');
        ga.oninput = () => document.getElementById('ga-valor').innerText = ga.value;
        gi.oninput = () => document.getElementById('gi-valor').innerText = gi.value;

        // --- 2. EL CEREBRO CONECTADO (La Magia) ---
        window.ejecutarAuditoria = async () => {
            const intencion = document.getElementById('intencion').value;
            if(!intencion) return alert("Por favor, define tu intenci√≥n para que TITAN la analice.");

            // Referencias visuales
            const panel = document.getElementById('resultado-panel');
            const tit = document.getElementById('titulo-resultado');
            const sub = document.getElementById('subtitulo-resultado');
            const pay = document.getElementById('paypal-button-container');
            const btn = document.querySelector('button');

            // Feedback de "Pensando"
            btn.innerText = "üõ∞Ô∏è CONECTANDO CON N√öCLEO...";
            btn.disabled = true;
            panel.classList.remove('hidden');
            tit.innerText = "ANALIZANDO ENTROP√çA...";
            tit.className = "font-orbitron text-cyan-400 text-xl animate-pulse";
            sub.innerText = "Consultando red neuronal en Google Cloud...";

            try {
                // AQUI OCURRE EL MILAGRO: Llamada a tu Servidor Real
                const response = await fetch(TITAN_CLOUD_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-MBR-Auth": TITAN_PUBLIC_KEY
                    },
                    body: JSON.stringify({
                        observation: { 
                            // Convertimos los sliders (0-100) a valores normalizados (0.0-1.0)
                            ga_value: parseInt(ga.value) / 100, 
                            gi_value: parseInt(gi.value) / 100,
                            user_intent: intencion 
                        },
                        priors: { p_o: 0.5 } 
                    })
                });

                if (!response.ok) throw new Error("Error de conexi√≥n con TITAN");

                const data = await response.json();
                
                // Leemos la decisi√≥n REAL del cerebro Python
                // Buscamos 'pi_opt' (Pol√≠tica √ìptima)
                const decision = data.fenix?.policy?.pi_opt || "hold"; 
                const confianza = data.fenix?.F || 0.5;

                // --- 3. RESPUESTA AL HUMANO ---
                if (decision === "act") {
                    tit.innerText = "‚úÖ V√çA LIBRE: ACT√öA AHORA";
                    tit.className = "font-orbitron text-green-400 text-3xl mb-2 glow-gold";
                    sub.innerText = `El sistema calcula que el costo de no actuar es fatal. Certeza: ${(confianza*100).toFixed(1)}%`;
                    
                    // Estrategia: Le damos la respuesta GRATIS, pero vendemos el "Certificado Pro"
                    pay.style.opacity = "1";
                    pay.style.pointerEvents = "all";
                    renderPayPal(); // Solo renderizamos si es positivo
                } else {
                    tit.innerText = "üõë PRECAUCI√ìN: ESPERA";
                    tit.className = "font-orbitron text-red-500 text-3xl mb-2";
                    sub.innerText = "La incertidumbre es demasiado alta. Recalibra tu intenci√≥n.";
                    pay.style.opacity = "0.2";
                    pay.style.pointerEvents = "none";
                }

                // Guardar rastro si Firebase est√° activo
                if(userId && db) {
                    setDoc(doc(db, `artifacts/tcis-titan-12/audits/${crypto.randomUUID()}`), {
                        uid: userId, intent: intencion, raw_response: data, ts: serverTimestamp()
                    });
                }

            } catch (error) {
                console.error(error);
                tit.innerText = "‚ö†Ô∏è ENLACE INTERRUMPIDO";
                tit.className = "text-yellow-500";
                sub.innerText = "El servidor TITAN est√° ocupado o sin conexi√≥n. Intenta de nuevo.";
            } finally {
                btn.innerText = "RE-CALCULAR INTENCI√ìN";
                btn.disabled = false;
            }
        };

        function renderPayPal() {
            const container = document.getElementById('paypal-button-container');
            if (container.innerHTML !== "") return;
            
            try {
                paypal.Buttons({
                    style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'pay' },
                    createOrder: (data, actions) => {
                        return actions.order.create({
                            purchase_units: [{ amount: { value: '5.00' }, description: 'Certificado TITAN PRO' }]
                        });
                    },
                    onApprove: (data, actions) => {
                        return actions.order.capture().then((details) => {
                            alert(`¬°Gracias ${details.payer.name.given_name}! Eres parte de la √©lite.`);
                            // Aqu√≠ ir√≠a la l√≥gica de redirecci√≥n a la zona VIP
                        });
                    }
                }).render('#paypal-button-container');
            } catch (e) { console.log("PayPal SDK no carg√≥ correctamente"); }
        }
    </script>

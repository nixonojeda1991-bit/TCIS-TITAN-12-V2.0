<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITÁN VΩ.11 | OMNICORE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --bg-black: #020202; }
        body { margin: 0; background-color: var(--bg-black); color: white; font-family: 'JetBrains Mono', monospace; overflow-x: hidden; }
        
        /* PANTALLA DE CARGA (Aparece inmediatamente) */
        #loader-screen {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-ring {
            width: 60px; height: 60px; border: 4px solid rgba(212, 175, 55, 0.2);
            border-top: 4px solid var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite; mb-4;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ocultar contenido hasta que cargue Tailwind */
        .cloak { opacity: 0; transition: opacity 1s; }
        .visible { opacity: 1; }
    </style>
</head>
<body>

    <div id="loader-screen">
        <div class="loader-ring"></div>
        <h2 style="color: #D4AF37; font-family: 'Orbitron', sans-serif; letter-spacing: 4px; margin-top: 20px;">TITÁN VΩ.11</h2>
        <p style="color: #666; font-size: 10px; text-transform: uppercase;">Estableciendo enlace satelital...</p>
    </div>

    <div id="main-app" class="cloak">
        <div id="canvas-container" style="position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.6;"></div>

        <div class="relative z-10 grid grid-cols-1 lg:grid-cols-12 h-screen p-4 md:p-8 gap-6 overflow-hidden">
            
            <div class="lg:col-span-4 flex flex-col gap-6 overflow-y-auto">
                <div class="bg-black/80 backdrop-blur-md border border-yellow-600/30 p-8 rounded-lg relative overflow-hidden shadow-2xl">
                    <div style="position: absolute; top:0; left:0; width:100%; height:2px; background:#D4AF37; box-shadow:0 0 10px #D4AF37;"></div>
                    <h2 class="text-yellow-500 font-orbitron text-sm mb-8 tracking-widest uppercase">❖ Parámetros de Misión</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-2 tracking-widest"><span>VOLUNTAD (GI)</span><span id="gi-val" class="text-yellow-500 font-bold">50%</span></div>
                            <input type="range" id="gi-slider" class="w-full h-1 bg-gray-800 appearance-none accent-yellow-500 cursor-pointer" oninput="updateUI('gi', this.value)">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-gray-400 mb-2 tracking-widest"><span>ACCIÓN (GA)</span><span id="ga-val" class="text-yellow-500 font-bold">50%</span></div>
                            <input type="range" id="ga-slider" class="w-full h-1 bg-gray-800 appearance-none accent-yellow-500 cursor-pointer" oninput="updateUI('ga', this.value)">
                        </div>
                        
                        <div class="space-y-2 pt-4">
                            <label class="text-[10px] text-yellow-600 font-bold uppercase tracking-widest">OBJETIVO</label>
                            <textarea id="user-intent" class="w-full h-24 bg-black/50 border border-white/10 p-3 text-sm text-gray-200 focus:border-yellow-500 outline-none font-mono" placeholder="Escriba su objetivo..."></textarea>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-yellow-600 font-bold uppercase tracking-widest">WHATSAPP (Requerido)</label>
                            <input type="tel" id="user-phone" class="w-full bg-black/50 border-l-2 border-yellow-500 p-3 text-sm text-yellow-500 font-mono outline-none" placeholder="+58 412...">
                        </div>

                        <button id="main-sync-btn" onclick="executeSync()" class="w-full py-4 bg-gradient-to-r from-yellow-700 to-yellow-500 text-black font-black text-sm tracking-[0.2em] hover:brightness-110 transition-all shadow-lg shadow-yellow-500/20">
                            EJECUTAR PROTOCOLO
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 flex flex-col gap-6 overflow-hidden">
                <header class="bg-black/80 backdrop-blur-md border-b border-white/10 h-20 rounded-lg flex items-center px-8 justify-between">
                    <div>
                        <span class="block text-3xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white via-yellow-400 to-yellow-800 font-orbitron">TITÁN VΩ.11</span>
                        <span class="text-[9px] text-gray-500 tracking-[0.6em] uppercase">Soberanía Digital</span>
                    </div>
                </header>

                <div class="flex-1 bg-black/60 backdrop-blur-md border border-white/5 rounded-lg p-8 flex flex-col justify-center items-center relative overflow-hidden">
                    <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#D4AF37 1px, transparent 1px); background-size: 20px 20px;"></div>

                    <div id="state-idle" class="text-center opacity-50">
                        <div class="w-24 h-24 border border-dashed border-yellow-500/50 rounded-full flex items-center justify-center mx-auto mb-6 animate-spin-slow">
                            <div class="w-16 h-16 bg-yellow-500/10 rounded-full"></div>
                        </div>
                        <p class="text-xs tracking-[0.5em] text-yellow-500 uppercase font-orbitron">Esperando Comandos</p>
                    </div>

                    <div id="state-processing" class="hidden w-full max-w-lg text-center">
                        <div id="log-window" class="text-xs text-yellow-400 font-mono mb-6 h-32 overflow-hidden text-left border-l-2 border-yellow-500/30 pl-4"></div>
                        <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden">
                            <div id="sync-progress" class="h-full bg-yellow-500 w-0 transition-all duration-300"></div>
                        </div>
                    </div>

                    <div id="state-success" class="hidden w-full max-w-2xl text-center z-10">
                        <h2 id="result-title" class="text-5xl font-black italic mb-6 text-yellow-500 font-orbitron drop-shadow-lg">AUTORIZADO</h2>
                        <div class="bg-black/80 border-l-4 border-yellow-500 p-6 rounded-r-xl mb-8 shadow-2xl">
                            <p id="ia-final-message" class="text-gray-200 text-xl font-serif italic"></p>
                        </div>
                        <div id="payment-zone" class="flex flex-col items-center gap-4 animate-bounce-in">
                            <p class="text-[10px] text-yellow-500 uppercase tracking-widest">Acceso a Consultoría: $7.00 USD</p>
                            <div id="paypal-button-container" class="w-full max-w-xs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=BAA1vZa0wSM2Mz7GjGZTtvTJGjguge3Sbfq3HzEirH-logMDlVWhxdgxSZSo73-wnDVoSBJJLiZAIsv9Ck&currency=USD"></script>

    <script>
        // --- CONFIGURACIÓN ---
        const TITAN_ENDPOINT = "https://us-central1-tcis-titan-12.cloudfunctions.net/agos-v11";
        const TITAN_AUTH = "dosespejossemiranyelpezrespirafueradelagua"; 
        
        // --- INICIALIZADOR SEGURO ---
        window.addEventListener('load', () => {
            // Cuando todo ha cargado, ocultamos loader y mostramos app
            setTimeout(() => {
                document.getElementById('loader-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('visible');
                initSpace(); // Iniciamos Three.js solo cuando ya se ve la pagina
            }, 1000);
        });

        // --- VISUALES ---
        function initSpace() {
            if(typeof THREE === 'undefined') return; // Seguridad si falla el CDN
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for(let i=0; i<1500; i++) vertices.push((Math.random()-0.5)*1000, (Math.random()-0.5)*1000, (Math.random()-0.5)*1000);
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({ color: 0xD4AF37, size: 0.8, transparent: true, opacity: 0.5 });
            const stars = new THREE.Points(geometry, material);
            scene.add(stars);
            camera.position.z = 300;
            function animate() { requestAnimationFrame(animate); stars.rotation.y += 0.0005; renderer.render(scene, camera); }
            animate();
        }

        // --- LÓGICA DE NEGOCIO ---
        function updateUI(type, val) { document.getElementById(`${type}-val`).innerText = val + "%"; }

        async function executeSync() {
            const intent = document.getElementById('user-intent').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            
            if(!intent) { alert("ERROR: Ingrese una misión."); return; }
            if(!phone || phone.length < 7) { alert("SEGURIDAD: Identificación requerida."); return; }

            const fullIntent = `[CONTACTO: ${phone}] - INTENCIÓN: ${intent}`;

            // UI
            document.getElementById('state-idle').classList.add('hidden');
            document.getElementById('state-success').classList.add('hidden');
            document.getElementById('state-processing').classList.remove('hidden');
            const btn = document.getElementById('main-sync-btn');
            btn.disabled = true;

            // Logs falsos para UX
            const logWin = document.getElementById('log-window');
            const logs = ["CONECTANDO...", "ENVIANDO DATOS...", "PROCESANDO...", "COMPLETADO"];
            logWin.innerHTML = "";
            for(let i=0; i<logs.length; i++) {
                logWin.innerHTML += `<div>> ${logs[i]}</div>`;
                document.getElementById('sync-progress').style.width = ((i+1)*25) + "%";
                await new Promise(r => setTimeout(r, 500));
            }

            try {
                // LLAMADA AL BACKEND
                // AUMENTAMOS EL TIEMPO DE ESPERA VISUAL SI EL BACKEND ES LENTO
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 25000); // 25s timeout

                const response = await fetch(TITAN_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-MBR-Auth': TITAN_AUTH },
                    body: JSON.stringify({ 
                        user_intent: fullIntent, 
                        observation: { 
                            gi_value: document.getElementById('gi-slider').value / 100, 
                            ga_value: document.getElementById('ga-slider').value / 100 
                        } 
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();
                document.getElementById('state-processing').classList.add('hidden');
                document.getElementById('state-success').classList.remove('hidden');
                document.getElementById('ia-final-message').innerText = data.message;
                
                if(data.decision === 'act') {
                    document.getElementById('result-title').innerText = "AUTORIZADO";
                    document.getElementById('result-title').classList.add('text-yellow-500');
                    document.getElementById('payment-zone').classList.remove('hidden');
                    renderPayPal();
                } else {
                    document.getElementById('result-title').innerText = "DENEGADO";
                    document.getElementById('result-title').classList.remove('text-yellow-500');
                    document.getElementById('result-title').classList.add('text-red-600');
                    document.getElementById('payment-zone').classList.add('hidden');
                }

            } catch (error) {
                console.error(error);
                alert("ERROR DE CONEXIÓN: El servidor tardó demasiado. Intente de nuevo.");
                document.getElementById('state-processing').classList.add('hidden');
                document.getElementById('state-idle').classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        }

        function renderPayPal() {
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = '';
            if(window.paypal) {
                paypal.Buttons({
                    style: { shape: 'rect', color: 'gold', layout: 'vertical', label: 'pay' },
                    createOrder: function(data, actions) {
                        return actions.order.create({ purchase_units: [{ description: "Acceso TITÁN VΩ.11", amount: { value: '7.00' } }] });
                    },
                    onApprove: function(data, actions) {
                        return actions.order.capture().then(function(details) {
                            const transactionId = details.id;
                            setTimeout(() => {
                                const phone = "584124577822"; 
                                const text = `Comandante, pago realizado ($7.00). ID: ${transactionId}. Mi número registrado es este.`;
                                window.location.href = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
                            }, 1500);
                        });
                    }
                }).render('#paypal-button-container');
            }
        }
    </script>
</body>
</html>

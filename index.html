<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCIS TITAN 12 V2.3 | Protocolo de Decisión Inevitable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #1e3a8a;
            --color-secondary: #fcd34d;
            --color-success: #10b981;
            --color-fail: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 1rem;
        }
        .output-success { border-left: 5px solid var(--color-success); background-color: #d1fae5; color: #065f46; }
        .output-fail { border-left: 5px solid var(--color-fail); background-color: #fee2e2; color: #991b1b; }
        .form-group label { font-weight: 600; display: block; margin-bottom: 0.5rem; color: var(--color-primary); }
        .form-group input[type="text"], .form-group textarea, .form-group input[type="email"], .form-group input[type="password"] { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); transition: border-color 0.2s; }
        .form-group input[type="range"] { width: 85%; margin-right: 1rem; -webkit-appearance: none; appearance: none; height: 8px; background: #d1d5db; border-radius: 4px; }
        .form-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--color-primary); cursor: pointer; border-radius: 50%; }
        .range-container { display: flex; align-items: center; }
        .range-value { font-weight: 700; width: 3rem; text-align: right; color: var(--color-primary); }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container max-w-4xl w-full bg-white shadow-xl rounded-xl p-6 md:p-10">
        <header class="mb-8 relative"> <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-900 leading-tight">TCIS TITAN 12 V2.3</h1>
            <p class="text-xl font-bold text-center text-gray-700 leading-tight mb-2">PROTOCOLO DE DECISIÓN INEVITABLE</p>
            <p class="text-sm text-center text-gray-500 italic">Tasa de Conversión de Intención Soberana. Aplica la Ley Cero: Minimiza el riesgo **G**.</p>
            
            <div id="authStatus" class="text-xs text-center mt-3 p-2 bg-gray-100 rounded-lg">Cargando estado de usuario...</div>
            
            <button id="showAdminButton" class="text-xs text-gray-400 hover:text-yellow-400 absolute top-2 right-2 p-1 rounded-full border border-gray-700">MODO ADMIN</button>
        </header>
        
        <div class="bg-blue-50 border-l-4 border-blue-800 p-5 mb-8 rounded-lg">
            <p class="font-bold text-blue-800 mb-2">AUDITORÍA CAUSAL TITÁN:</p>
            <ul class="list-disc pl-5 text-sm text-blue-700 space-y-1">
                <li>**EGT (Escala de Gravedad Titán):** Cuantifica tu riesgo para eliminar el miedo.</li>
                <li>**Garantiza la Coherencia (L.I.S.):** Valida contra tu Identidad Fija definida.</li>
            </ul>
        </div>
      
        <form id="pdcForm" class="space-y-6">
            <div class="form-group">
                <label for="objective">1. ECO: Intención Soberana (El objetivo a ejecutar)</label>
                <input type="text" id="objective" required placeholder="Ej: Lanzar mi MVP de IA en 3 meses.">
            </div>
            <div class="form-group">
                <label for="identity">1.b. L.I.S. (Identidad Fija): Tu Propósito Central</label>
                <input type="text" id="identity" required placeholder="Ej: Ser un proveedor sostenible de soluciones de gobernanza.">
            </div>
            <div class="form-group">
                <label for="riskAction">2. FÉNIX | RIESGO G(A): Riesgo si INTENTA la acción (0-100)</label>
                <div class="range-container">
                    <input type="range" id="riskAction" min="0" max="100" value="50" oninput="updateRangeValue('riskAction', 'riskActionValue')">
                    <span id="riskActionValue" class="range-value">50</span>
                </div>
            </div>
            <div class="form-group">
                <label for="riskInaction">3. FÉNIX | RIESGO G(I): Riesgo si NO HACE NADA (0-100)</label>
                <div class="range-container">
                    <input type="range" id="riskInaction" min="0" max="100" value="50" oninput="updateRangeValue('riskInaction', 'riskInactionValue')">
                    <span id="riskInactionValue" class="range-value">50</span>
                </div>
            </div>
            <div class="form-group">
                <label for="resources">4. L.I.S. (Recursos Cuantificados): Menciona tus 3 Recursos Críticos</label>
                <textarea id="resources" required rows="4" placeholder="Ej: 1. 20 horas a la semana. 2. $500 de capital de marketing..."></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300">EJECUTAR AUDITORÍA TITÁN (LOGOS)</button>
        </form>

        <div id="output" class="mt-8 p-4 rounded-lg text-sm transition duration-300">El resultado de la Auditoría FÉNIX aparecerá aquí.</div>
        
        <div class="mt-12 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">5. Memoria Gráfica del Usuario (MGU)</h2>
            <p class="text-sm text-gray-500 mb-4">Historial de Decisiones FÉNIX. Es privado para cada sesión.</p>
            <div id="historyContainer" class="space-y-4">
                <p id="loadingHistory" class="text-gray-500 italic">Cargando historial de decisiones...</p>
           </div>
        </div>

        <div id="proUpgrade" class="mt-10 p-6 border-2 border-yellow-400 bg-yellow-50 rounded-xl text-center shadow-md">
            <h3 class="text-xl font-bold text-blue-800">TCIS TITAN PRO: CADENA DE EJECUCIÓN LOGOS</h3>
            <p class="mt-2 text-gray-700">Obtén el análisis estructurado de la IA y el **L.I.S. Scorecard** por solo **$4.99 USD/mes.**</p>
            
            <div class="mt-4">
                <div id="paypal-button-container-P-33398171NB044211UNE65YKA" class="block"></div>
            </div>
            
            <div class="mt-4 space-y-4">
                <a href="https://www.paypal.com/ncp/payment/4D5QYC5JFSEGE" target="_blank" class="flex items-center justify-center bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 shadow-lg space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></svg>
                    <span>GRATIFICACIÓN AL CREADOR</span>
                </a>
                <a href="https://wa.me/584124577822?text=Hola%2C%20necesito%20ayuda%20para%20acceder%20a%20TCIS%20TITAN%20PRO." target="_blank" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg w-full transition duration-300 shadow-lg space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 2C6.477 2 2 6.477 2 12c0 3.189 1.583 6.007 4.02 7.728l-.513 1.538 1.57-1.026A9.975 9.975 0 0 0 12 22c5.523 0 10-4.477 10-10S17.523 2 12 2zm3.5 13.78c-.28 0-.55-.084-.78-.25l-2.02-1.35c-.2-.14-.42-.2-.65-.2-.16 0-.3.04-.45.1-.38.16-.65.48-.65.85v1.25c0 .37-.27.7-.65.85-.38.15-.79.16-1.16.03-.36-.12-.66-.37-.86-.73-1.02-1.85-1.52-4.1-1.52-6.26 0-.17.02-.34.05-.5.1-.4.4-.73.78-.86.38-.13.79-.12-.15-.4z"/></svg>
                    <span>SOPORTE (WHATSAPP)</span>
                </a>
            </div>
        </div>

        <div class="mt-8 p-6 bg-gray-900 border-2 border-gray-700 rounded-xl text-center shadow-lg">
            <h3 class="text-lg font-bold text-white tracking-widest uppercase">Licenciamiento Corporativo & Gobierno</h3>
            <p class="text-gray-400 text-xs mt-2 mb-4 px-4">
                <span class="text-red-500 font-bold">ADVERTENCIA LEGAL:</span> La suscripción "Titan Pro" ($4.99) es una licencia estrictamente 
                <strong>INDIVIDUAL y NO COMERCIAL</strong>. El uso de este algoritmo para decisiones corporativas, fusiones, 
                políticas públicas o gestión de activos de alto valor requiere una <strong>Licencia de Gobernanza TITÁN (Enterprise)</strong>.
            </p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-4">
                <div class="text-left text-gray-300 text-sm space-y-1">
                    <p>✅ Agentes IA Dedicados (ADN Exclusivo)</p>
                    <p>✅ Auditoría de Riesgo >$1M USD</p>
                    <p>✅ Integración API Privada</p>
                </div>
            </div>
            <a href="https://wa.me/584124577822?text=Soy%20representante%20de%20una%20Entidad/Corporación.%20Requiero%20información%20sobre%20la%20Licencia%20TITAN%20GOVERNANCE%20para%20alto%20nivel." 
                target="_blank" 
                class="mt-6 inline-block w-full md:w-auto bg-transparent hover:bg-white hover:text-black text-white border border-white font-bold py-2 px-6 rounded transition duration-300">
                SOLICITAR ACCESO ENTERPRISE
            </a>
        </div>

        <div id="titanContent" class="mt-10 p-8 border-2 border-blue-500 bg-blue-900 rounded-xl text-center shadow-2xl" style="display: none;">
            <div class="mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-yellow-400 mx-auto animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h2 class="text-3xl font-extrabold text-white tracking-widest">ACCESO CONCEDIDO</h2>
            <p class="mt-4 text-xl text-blue-200">Bienvenido al Nivel Élite, Arquitecto.</p>
            <div class="mt-8 space-y-4">
                <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                    <h4 class="text-yellow-400 font-bold">1. L.I.S. SCORECARD</h4>
                    <a href="#" class="inline-block bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded transition mt-2">DESCARGAR PDF</a>
                </div>
                <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                    <h4 class="text-blue-400 font-bold">2. ANÁLISIS ESTRUCTURADO IA</h4>
                    <a href="#" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition mt-2">ACCEDER AHORA</a>
                </div>
            </div>
            <p class="mt-6 text-xs text-gray-500">ID de Sesión: <span id="userSessionId" class="font-mono">...</span></p>
        </div>
        
        <div id="adminLoginModule" class="mt-8 p-6 bg-gray-900 rounded-xl text-white shadow-xl relative" style="display: none;">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ACCESO DE ARQUITECTO</h3>
            <p class="text-xs text-gray-400 mb-4">Ingrese sus credenciales únicas.</p>
            <div class="space-y-4">
                <input type="email" id="adminEmail" placeholder="Email de Administrador" class="w-full p-2 rounded text-black">
                <input type="password" id="adminPassword" placeholder="Clave de Administrador" class="w-full p-2 rounded text-black">
                <button id="adminLoginButton" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-2 rounded transition duration-300">
                    INICIAR SESIÓN SOBERANA
                </button>
                <p id="adminMessage" class="text-sm text-red-400 mt-2 hidden"></p>
            </div>
        </div>

    </div>

    <script type="module">
        // 1. IMPORTACIONES CENTRALIZADAS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, query, onSnapshot, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. CONFIGURACIÓN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDwlyMkTfH4FFmerYDKkDGh18NUKQQ4hP0",
            authDomain: "tcis-titan-12.firebaseapp.com",
            projectId: "tcis-titan-12",
            storageBucket: "tcis-titan-12.firebasestorage.app",
            messagingSenderId: "298942508038",
            appId: "1:298942508038:web:a7107a1cdc65216ec96787",
            measurementId: "G-F3J54D4M57"
        };
        const appId = firebaseConfig.projectId;

        // 3. INICIALIZACIÓN
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;

        // 4. FUNCIONES DE INTERFAZ (RANGOS)
        const updateRangeValue = (inputId, valueId) => {
            document.getElementById(valueId).textContent = document.getElementById(inputId).value;
        };
        window.updateRangeValue = updateRangeValue; 

        // 5. LÓGICA DE PAGO Y DESBLOQUEO
        const desbloquearContenido = (isAdmin = false) => {
            document.getElementById('proUpgrade').style.display = 'none';
            document.getElementById('titanContent').style.display = 'block';
            document.getElementById('userSessionId').innerText = userId || (isAdmin ? "ADMIN_SOBERANO" : "PRO_USER");
            document.getElementById('titanContent').scrollIntoView({ behavior: 'smooth' });
        };
        window.desbloquearContenido = desbloquearContenido; 

        async function registrarPagoExitoso(subscriptionId) {
            if (!userId) return;
            try {
                await setDoc(doc(db, "artifacts", appId, "users", userId), {
                    isPro: true, plan: "TCIS TITAN PRO", paypalSubscriptionId: subscriptionId,
                    fechaPago: new Date().toISOString(), status: "ACTIVO"
                }, { merge: true });
                console.log("Pago registrado.");
                desbloquearContenido();
            } catch (e) {
                console.error("Error pago:", e);
                desbloquearContenido();
            }
        }

        // 6. LÓGICA DE AUTENTICACIÓN ADMINISTRATIVA
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const messageEl = document.getElementById('adminMessage');

            messageEl.textContent = '';
            messageEl.classList.add('hidden');
            
            if (!email || !password) {
                 messageEl.textContent = `VETO: Ingrese credenciales.`;
                 messageEl.classList.remove('hidden');
                 return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                userId = userCredential.user.uid; 
                
                desbloquearContenido(true); 
                document.getElementById('adminLoginModule').style.display = 'none';
                document.getElementById('authStatus').innerHTML = `Estado: <span class="font-semibold text-yellow-600">ADMINISTRADOR</span> | ID: <span class="font-mono text-xs">${userId}</span>`;
                loadDecisionHistory();
            
            } catch (error) {
                console.error("Error de Admin Login:", error);
                messageEl.textContent = `VETO: Credenciales no reconocidas. ${error.code}`;
                messageEl.classList.remove('hidden');
            }
        }


        // 7. AUTENTICACIÓN Y ARRANQUE INICIAL
        signInAnonymously(auth).catch((error) => console.error("Error Auth:", error));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                const statusEl = document.getElementById('authStatus');
                
                const checkProStatus = async () => {
                    const userDocRef = doc(db, "artifacts", appId, "users", userId);
                    const userDoc = await getDoc(userDocRef);
                    const isPro = userDoc.exists() && userDoc.data().isPro;

                    if (!user.isAnonymous) { 
                        desbloquearContenido(true);
                        statusEl.innerHTML = `Estado: <span class="font-semibold text-yellow-600">ADMINISTRADOR</span> | ID: <span class="font-mono text-xs">${userId}</span>`;
                    } else if (isPro) { 
                        desbloquearContenido();
                        statusEl.innerHTML = `Estado: <span class="font-semibold text-green-700">PRO SOSTENIBLE</span> | ID: <span class="font-mono text-xs">${userId}</span>`;
                    } else { 
                        statusEl.innerHTML = `Estado: <span class="font-semibold text-green-700">OPERATIVO</span> | ID: <span class="font-mono text-xs">${userId}</span>`;
                    }
                };

                checkProStatus();
                loadDecisionHistory(); 
            }
        });
        
        // 8. LÓGICA DE AUDITORÍA (DECISIONES FÉNIX)
        async function calculatePDC(event) {
            event.preventDefault();
            if (!userId) {
                alert("Esperando conexión con el sistema... intente en unos segundos.");
                return;
            }

            const objective = document.getElementById('objective').value;
            const identity = document.getElementById('identity').value;
            const riskAction = parseInt(document.getElementById('riskAction').value);
            const riskInaction = parseInt(document.getElementById('riskInaction').value);
            const resources = document.getElementById('resources').value;
            const outputDiv = document.getElementById('output');
            const proUpgradeDiv = document.getElementById('proUpgrade');

            outputDiv.className = 'mt-8 p-4 rounded-lg text-sm transition duration-300';
            let finalDecision, resultText;
            const titanContentVisible = document.getElementById('titanContent').style.display === 'block';

            if (riskAction < riskInaction) {
                finalDecision = "MANDATO DE EJECUCIÓN (ACI): DECISIÓN INEVITABLE";
                resultText = `<p class="font-bold text-lg mb-2">${finalDecision}</p>
                              <p class="font-semibold">**LEY CERO APROBADA:** Riesgo Acción < Riesgo Inacción. Ejecute.</p>`;
                outputDiv.classList.add('output-success');
                outputDiv.innerHTML = resultText;
                
                if (!titanContentVisible) {
                    proUpgradeDiv.style.display = 'block'; 
                } else {
                    proUpgradeDiv.style.display = 'none';
                }
                
            } else {
                finalDecision = "VETO TITÁN: PARÁLISIS OPERATIVA REQUERIDA";
                resultText = `<p class="font-bold text-lg mb-2">${finalDecision}</p>
                              <p class="font-semibold">**LEY CERO VIOLADA:** Riesgo Acción >= Riesgo Inacción. Reevalúe.</p>`;
                outputDiv.classList.add('output-fail');
                outputDiv.innerHTML = resultText;
                proUpgradeDiv.style.display = 'none';
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/decisiones_fenix`), {
                    objective, identity, riskAction, riskInaction, resources, decision: finalDecision,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Error guardando decisión:", e); }
        }

        // 9. LÓGICA DE HISTORIAL (MGU)
        function loadDecisionHistory() {
            if (!userId) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/decisiones_fenix`));
            onSnapshot(q, (snapshot) => {
                const decisions = [];
                snapshot.forEach(doc => decisions.push({ id: doc.id, ...doc.data() }));
                decisions.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                const container = document.getElementById('historyContainer');
                if (!container) return;
                
                if (decisions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic">Sin registros aún.</p>';
                    return;
                }

                container.innerHTML = decisions.map(d => {
                    const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString('es-ES') : 'Fecha desconocida';
                    const isExec = d.decision && d.decision.includes('EJECUCIÓN');
                    return `
                        <div class="p-4 border-l-4 rounded-lg shadow-sm ${isExec ? 'border-green-600 bg-green-50' : 'border-red-600 bg-red-50'}">
                            <div class="flex justify-between font-bold ${isExec ? 'text-green-800' : 'text-red-800'}">
                                <span>${isExec ? 'EJECUTAR' : 'VETO'}</span><span class="text-xs text-gray-500 font-normal">${date}</span>
                            </div>
                            <p class="text-sm font-semibold text-gray-800 mt-1">${d.objective}</p>
                        </div>`;
                }).join('');
            });
        }

        // 10. CARGAR PAYPAL Y LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            updateRangeValue('riskAction', 'riskActionValue');
            updateRangeValue('riskInaction', 'riskInactionValue');
            
            document.getElementById('pdcForm').addEventListener('submit', calculatePDC);

            const adminLoginButton = document.getElementById('adminLoginButton');
            if (adminLoginButton) {
                adminLoginButton.addEventListener('click', adminLogin);
            }
            
            // Listener del botón de emergencia (MODO ADMIN)
            const showAdminButton = document.getElementById('showAdminButton');
            if (showAdminButton) {
                showAdminButton.addEventListener('click', () => {
                    const module = document.getElementById('adminLoginModule');
                    module.style.display = module.style.display === 'none' ? 'block' : 'none';
                    if(module.style.display === 'block') {
                        document.getElementById('adminEmail').focus();
                    }
                });
            }

            // Cargar Script de PayPal dinámicamente
            const scriptPP = document.createElement('script');
            scriptPP.src = "https://www.paypal.com/sdk/js?client-id=Ad5D0SGYDZUBG6ucm74UN76VRUVpOeFE0KTW2QmV5nZEfXsOD39R_phO6AtFGswwRaJC5o7_gJtfBipX&vault=true&intent=subscription";
            scriptPP.setAttribute('data-sdk-integration-source', 'button-factory');
            scriptPP.onload = () => {
                if (typeof paypal !== 'undefined' && document.getElementById('paypal-button-container-P-33398171NB044211UNE65YKA')) {
                    paypal.Buttons({
                        style: { shape: 'rect', color: 'gold', layout: 'vertical', label: 'subscribe' },
                        createSubscription: (data, actions) => actions.subscription.create({ plan_id: 'P-33398171NB044211UNE65YKA' }),
                        onApprove: (data, actions) => {
                            console.log('Pago Aprobado:', data.subscriptionID);
                            registrarPagoExitoso(data.subscriptionID);
                        }
                    }).render('#paypal-button-container-P-33398171NB044211UNE65YKA');
                }
            };
            document.head.appendChild(scriptPP);
        });
    </script>
</body>
</html>
